generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Card {
  id           Int     @id @default(autoincrement())
  cardId       Int     @unique @map("card_id")
  name         String
  displayName  String  @map("display_name")
  arcana       String
  shortMeaning String? @map("short_meaning")
  longMeaning  String? @map("long_meaning")
  keywords     Json
  imageUrl     String? @map("image_url")

  @@map("cards")
}

model User {
  id            String              @id @default(cuid())
  name          String?
  email         String?             @unique
  image         String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  referralCode  String?             @unique @default(cuid())
  referredById  String?             @map("referred_by_id")
  stars         Int                 @default(0)
  emailVerified Boolean             @default(false)
  accounts      Account[]
  transactions  CreditTransaction[]
  predictions   Prediction[]
  sessions      Session[]
  referredBy    User?               @relation("UserReferrals", fields: [referredById], references: [id], onDelete: SetNull)
  referrals     User[]              @relation("UserReferrals")

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  password              String?
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model Prediction {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userIdentifier String?   @map("user_identifier")
  question       String
  jobId          String?   @map("job_id")
  status         String    @default("PENDING")
  analysisResult Json?     @map("analysis_result")
  selectedCards  Json?     @map("selected_cards")
  finalReading   Json?     @map("final_reading")
  failureCode    String?   @map("failure_code")
  failureReason  String?   @map("failure_reason")
  createdAt      DateTime  @default(now()) @map("created_at")
  completedAt    DateTime? @map("completed_at")
  user           User?     @relation(fields: [userIdentifier], references: [id])

  @@index([userIdentifier])
  @@index([jobId])
  @@index([status])
  @@index([createdAt])
  @@map("predictions")
}

model CreditTransaction {
  id              String            @id @default(cuid())
  userId          String
  amount          Int
  balanceAfter    Int
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  metadata        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  stripeSessionId String?           @unique
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("credit_transactions")
}

model StarPackage {
  id          String         @id @default(cuid())
  name        String
  description String?
  stars       Int
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  prices      PackagePrice[]

  @@map("star_packages")
}

model PackagePrice {
  id            String      @id @default(cuid())
  packageId     String
  stripePriceId String      @unique
  amount        Float
  currency      String      @default("thb")
  active        Boolean     @default(true)
  isPromo       Boolean     @default(false)
  promoLabel    String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  package       StarPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@map("package_prices")
}

enum TransactionType {
  TOPUP
  PREDICTION
  REFUND
}

enum TransactionStatus {
  SUCCESS
  FAILED
  PENDING
}

model AgentConfig {
  id              String   @id @default(cuid())
  slug            String   @unique // gatekeeper, analyst, mystic
  encryptedPrompt String   @map("encrypted_prompt")
  version         Int      @default(1)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("agent_configs")
}
